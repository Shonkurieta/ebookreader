<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ebookreader-backend</a> &gt; <a href="index.source.html" class="el_package">com.example.ebookreader.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.example.ebookreader.controller;

import java.io.IOException;
import java.nio.file.Files;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import com.example.ebookreader.dto.ChapterDTO;
import com.example.ebookreader.model.Book;
import com.example.ebookreader.model.Chapter;
import com.example.ebookreader.model.User;
import com.example.ebookreader.service.AdminService;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;

@RestController
@RequestMapping(&quot;/api/admin&quot;)
@CrossOrigin(origins = &quot;*&quot;)
@PreAuthorize(&quot;hasRole(\'ADMIN\')&quot;)
@Tag(name = &quot;Администрирование&quot;, description = &quot;API для управления книгами, главами и пользователями&quot;)
public class AdminController {

    private final AdminService adminService;

    @Autowired
<span class="nc" id="L48">    public AdminController(AdminService adminService) {</span>
<span class="nc" id="L49">        this.adminService = adminService;</span>
<span class="nc" id="L50">    }</span>

    // === УПРАВЛЕНИЕ КНИГАМИ ===

    @Operation(summary = &quot;Получить список всех книг&quot;)
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Успешный запрос&quot;)
    @GetMapping(&quot;/books&quot;)
    public ResponseEntity&lt;List&lt;Book&gt;&gt; getAllBooks() {
<span class="nc" id="L58">        return ResponseEntity.ok(adminService.getAllBooks());</span>
    }

    @Operation(summary = &quot;Получить книгу по ID&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Книга найдена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Книга не найдена&quot;)
    })
    @GetMapping(&quot;/books/{id}&quot;)
    public ResponseEntity&lt;Book&gt; getBook(@PathVariable Long id) {
<span class="nc" id="L68">        return adminService.getBookById(id)</span>
<span class="nc" id="L69">                .map(ResponseEntity::ok)</span>
<span class="nc" id="L70">                .orElse(ResponseEntity.notFound().build());</span>
    }

    @Operation(summary = &quot;Создать новую книгу&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;201&quot;, description = &quot;Книга успешно создана&quot;),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Неверные входные данные&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @PostMapping(value = &quot;/books&quot;, consumes = &quot;multipart/form-data&quot;)
    public ResponseEntity&lt;Book&gt; createBook(
            @RequestPart(&quot;title&quot;) String title,
            @RequestPart(&quot;author&quot;) String author,
            @RequestPart(value = &quot;description&quot;, required = false) String description,
            @RequestPart(value = &quot;cover&quot;, required = false) MultipartFile cover
    ) throws IOException {
<span class="nc" id="L86">        Book newBook = adminService.createBook(title, author, description, cover);</span>
<span class="nc" id="L87">        return ResponseEntity.status(HttpStatus.CREATED).body(newBook);</span>
    }

    @Operation(summary = &quot;Обновить существующую книгу&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Книга успешно обновлена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Книга не найдена&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @PutMapping(value = &quot;/books/{id}&quot;)
    public ResponseEntity&lt;Book&gt; updateBook(@PathVariable Long id, @RequestBody Book bookDetails) {
<span class="nc" id="L98">        Book updatedBook = adminService.updateBook(id, bookDetails);</span>
<span class="nc" id="L99">        return ResponseEntity.ok(updatedBook);</span>
    }

    @Operation(summary = &quot;Удалить книгу по ID&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Книга успешно удалена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Книга не найдена&quot;)
    })
    @DeleteMapping(&quot;/books/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteBook(@PathVariable Long id) {
<span class="nc" id="L109">        adminService.deleteBook(id);</span>
<span class="nc" id="L110">        return ResponseEntity.ok().build();</span>
    }

    @Operation(summary = &quot;Получить обложку книги&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Обложка найдена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Обложка не найдена&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @GetMapping(&quot;/covers/{filename}&quot;)
    public ResponseEntity&lt;Resource&gt; getCover(@PathVariable String filename) throws IOException {
<span class="nc" id="L121">        Resource resource = adminService.getCover(filename);</span>
<span class="nc" id="L122">        String contentType = Files.probeContentType(resource.getFile().toPath());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (contentType == null) contentType = &quot;application/octet-stream&quot;;</span>
<span class="nc" id="L124">        return ResponseEntity.ok()</span>
<span class="nc" id="L125">                .contentType(MediaType.parseMediaType(contentType))</span>
<span class="nc" id="L126">                .header(HttpHeaders.CONTENT_DISPOSITION, &quot;attachment; filename=\&quot;&quot; + resource.getFilename() + &quot;\&quot;&quot;)</span>
<span class="nc" id="L127">                .body(resource);</span>
    }

    // === УПРАВЛЕНИЕ ГЛАВАМИ ===

    @Operation(summary = &quot;Получить список глав книги&quot;)
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Успешный запрос&quot;)
    @GetMapping(&quot;/books/{bookId}/chapters&quot;)
    public ResponseEntity&lt;List&lt;Chapter&gt;&gt; getChapters(@PathVariable Long bookId) {
<span class="nc" id="L136">        return ResponseEntity.ok(adminService.getChapters(bookId));</span>
    }

    @Operation(summary = &quot;Создать новую главу для книги&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Глава успешно создана&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Книга не найдена&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @PostMapping(&quot;/books/{bookId}/chapters&quot;)
    public ResponseEntity&lt;Chapter&gt; createChapter(@PathVariable Long bookId, @RequestBody ChapterDTO dto) {
<span class="nc" id="L147">        Chapter newChapter = adminService.createChapter(bookId, dto);</span>
<span class="nc" id="L148">        return ResponseEntity.ok(newChapter);</span>
    }

    @Operation(summary = &quot;Обновить главу книги&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Глава успешно обновлена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Глава или книга не найдена&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @PutMapping(&quot;/books/{bookId}/chapters/{chapterId}&quot;)
    public ResponseEntity&lt;Chapter&gt; updateChapter(
            @PathVariable Long bookId,
            @PathVariable Long chapterId,
            @RequestBody ChapterDTO dto) {
<span class="nc" id="L162">        Chapter updatedChapter = adminService.updateChapter(bookId, chapterId, dto);</span>
<span class="nc" id="L163">        return ResponseEntity.ok(updatedChapter);</span>
    }

    @Operation(summary = &quot;Удалить главу книги&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Глава успешно удалена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Глава или книга не найдена&quot;)
    })
    @DeleteMapping(&quot;/books/{bookId}/chapters/{chapterId}&quot;)
    public ResponseEntity&lt;Void&gt; deleteChapter(@PathVariable Long bookId, @PathVariable Long chapterId) {
<span class="nc" id="L173">        adminService.deleteChapter(bookId, chapterId);</span>
<span class="nc" id="L174">        return ResponseEntity.ok().build();</span>
    }

    // === УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ ===

    @Operation(summary = &quot;Получить список всех пользователей&quot;)
    @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Успешный запрос&quot;)
    @GetMapping(&quot;/users&quot;)
    public ResponseEntity&lt;List&lt;User&gt;&gt; getAllUsers() {
<span class="nc" id="L183">        return ResponseEntity.ok(adminService.getAllUsers());</span>
    }

    @Operation(summary = &quot;Получить пользователя по ID&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Пользователь найден&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Пользователь не найден&quot;)
    })
    @GetMapping(&quot;/users/{id}&quot;)
    public ResponseEntity&lt;User&gt; getUserById(@PathVariable Long id) {
<span class="nc" id="L193">        return adminService.getUserById(id)</span>
<span class="nc" id="L194">                .map(ResponseEntity::ok)</span>
<span class="nc" id="L195">                .orElse(ResponseEntity.notFound().build());</span>
    }

    @Operation(summary = &quot;Обновить роль пользователя&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Роль пользователя обновлена&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Пользователь не найден&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Ошибка сервера&quot;)
    })
    @PutMapping(&quot;/users/{id}/role&quot;)
    public ResponseEntity&lt;User&gt; updateUserRole(@PathVariable Long id, @RequestParam String newRole) {
<span class="nc" id="L206">        User updatedUser = adminService.updateUserRole(id, newRole);</span>
<span class="nc" id="L207">        return ResponseEntity.ok(updatedUser);</span>
    }

    @Operation(summary = &quot;Удалить пользователя по ID&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;200&quot;, description = &quot;Пользователь успешно удален&quot;),
            @ApiResponse(responseCode = &quot;404&quot;, description = &quot;Пользователь не найден&quot;)
    })
    @DeleteMapping(&quot;/users/{id}&quot;)
    public ResponseEntity&lt;Void&gt; deleteUser(@PathVariable Long id) {
<span class="nc" id="L217">        adminService.deleteUser(id);</span>
<span class="nc" id="L218">        return ResponseEntity.ok().build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>