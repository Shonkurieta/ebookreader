<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JwtFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ebookreader-backend</a> &gt; <a href="index.source.html" class="el_package">com.example.ebookreader.config</a> &gt; <span class="el_source">JwtFilter.java</span></div><h1>JwtFilter.java</h1><pre class="source lang-java linenums">package com.example.ebookreader.config;

import java.io.IOException;

import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import com.example.ebookreader.service.CustomUserDetailsService;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;

@Component
public class JwtFilter extends OncePerRequestFilter {
    
    private final JwtUtil jwtUtil;
    private final CustomUserDetailsService userDetailsService;

<span class="nc" id="L25">    public JwtFilter(JwtUtil jwtUtil, CustomUserDetailsService userDetailsService) {</span>
<span class="nc" id="L26">        this.jwtUtil = jwtUtil;</span>
<span class="nc" id="L27">        this.userDetailsService = userDetailsService;</span>
<span class="nc" id="L28">    }</span>

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {
        
<span class="nc" id="L36">        String path = request.getRequestURI();</span>
        
<span class="nc" id="L38">        System.out.println(&quot;\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•&quot;);</span>
<span class="nc" id="L39">        System.out.println(&quot;ğŸ”¹ JWT FILTER - REQUEST&quot;);</span>
<span class="nc" id="L40">        System.out.println(&quot;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•&quot;);</span>
<span class="nc" id="L41">        System.out.println(&quot;URI: &quot; + path);</span>
<span class="nc" id="L42">        System.out.println(&quot;Method: &quot; + request.getMethod());</span>
        
        // ğŸ”¹ ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ JWT Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ´Ğ»Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚Ğ¾Ğ², ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸ GraphQL
<span class="nc bnc" id="L45" title="All 2 branches missed.">        if (path.startsWith(&quot;/api/auth/&quot;) || </span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">            path.startsWith(&quot;/api/books&quot;) || </span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">            path.startsWith(&quot;/api/genres&quot;) ||</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">            path.startsWith(&quot;/api/test/&quot;) ||</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">            path.startsWith(&quot;/covers/&quot;) ||</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">            path.startsWith(&quot;/assets/&quot;) ||</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">            path.startsWith(&quot;/graphql&quot;) ||   // â† Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            path.startsWith(&quot;/graphiql&quot;)) {  // â† Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ</span>
            
<span class="nc" id="L54">            System.out.println(&quot;âœ… ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµÑÑƒÑ€Ñ - Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞº JWT Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°&quot;);</span>
<span class="nc" id="L55">            System.out.println(&quot;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n&quot;);</span>
<span class="nc" id="L56">            filterChain.doFilter(request, response);</span>
<span class="nc" id="L57">            return;</span>
        }
        
<span class="nc" id="L60">        final String authHeader = request.getHeader(&quot;Authorization&quot;);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">        System.out.println(&quot;Authorization header: &quot; + (authHeader != null ? authHeader.substring(0, Math.min(30, authHeader.length())) + &quot;...&quot; : &quot;NULL&quot;));</span>
        
        // ğŸ”¹ Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ° Authorization
<span class="nc bnc" id="L64" title="All 4 branches missed.">        if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L65">            System.out.println(&quot;âš ï¸ ĞĞµÑ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ğ¾Ğ³Ğ¾ Authorization Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°&quot;);</span>
<span class="nc" id="L66">            System.out.println(&quot;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n&quot;);</span>
<span class="nc" id="L67">            filterChain.doFilter(request, response);</span>
<span class="nc" id="L68">            return;</span>
        }
        
        try {
<span class="nc" id="L72">            final String jwtToken = authHeader.substring(7);</span>
<span class="nc" id="L73">            System.out.println(&quot;Token extracted (first 20 chars): &quot; + jwtToken.substring(0, Math.min(20, jwtToken.length())) + &quot;...&quot;);</span>
            
<span class="nc" id="L75">            final Long userId = jwtUtil.extractUserId(jwtToken);</span>
<span class="nc" id="L76">            System.out.println(&quot;User ID from token: &quot; + userId);</span>
            
<span class="nc bnc" id="L78" title="All 4 branches missed.">            if (userId != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {</span>
<span class="nc" id="L79">                System.out.println(&quot;ğŸ” Loading user details for ID: &quot; + userId);</span>
                
<span class="nc" id="L81">                UserDetails userDetails = userDetailsService.loadUserById(userId);</span>
<span class="nc" id="L82">                System.out.println(&quot;âœ… User details loaded&quot;);</span>
                
<span class="nc" id="L84">                System.out.println(&quot;ğŸ” Validating token...&quot;);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (jwtUtil.isTokenValid(jwtToken, userId)) {</span>
<span class="nc" id="L86">                    System.out.println(&quot;âœ… Token is VALID&quot;);</span>
                    
<span class="nc" id="L88">                    UsernamePasswordAuthenticationToken authToken =</span>
                            new UsernamePasswordAuthenticationToken(
                                    userDetails,
                                    null,
<span class="nc" id="L92">                                    userDetails.getAuthorities()</span>
                            );
<span class="nc" id="L94">                    authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span>
<span class="nc" id="L95">                    SecurityContextHolder.getContext().setAuthentication(authToken);</span>
                    
<span class="nc" id="L97">                    System.out.println(&quot;âœ… Authentication set in SecurityContext&quot;);</span>
<span class="nc" id="L98">                } else {</span>
<span class="nc" id="L99">                    System.out.println(&quot;âŒ Token is INVALID&quot;);</span>
                }
            }
<span class="nc" id="L102">        } catch (Exception e) {</span>
<span class="nc" id="L103">            System.err.println(&quot;âŒ ERROR in JWT Filter: &quot; + e.getClass().getName());</span>
<span class="nc" id="L104">            System.err.println(&quot;   Message: &quot; + e.getMessage());</span>
<span class="nc" id="L105">        }</span>
        
<span class="nc" id="L107">        System.out.println(&quot;â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n&quot;);</span>
<span class="nc" id="L108">        filterChain.doFilter(request, response);</span>
<span class="nc" id="L109">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>